<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coy.js TodoApp example</title>
  </head>
  <body>
    <div id="app"></div>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./signal.js"></script>
    <script src="./utils.js"></script>
    <script src="./coy.js"></script>
    <script src="./components.js"></script>
    <script src="./toast.js"></script>
    <script src="./bootstrap.js"></script>

    <script>
      const genId = idGenerator();

      const Layout = (child) => {
        return Div(
          $props({
            className:
              "min-h-screen w-full grid place-items-center bg-zinc-100 p-4",
          }),
          ToastProviderGlobal(),
          child
        );
      };

      const TodoItem = ({ todoSignal, onDone, onRemove }) => {
        const [text, setText] = signal("");
        console.log("look how this log only runs once for each item", todoSignal());


        return Div(
          $props({
            className: cn(() => [
              "flex justify-between gap-4 items-center p-2 w-full mb-1",
              todoSignal().done && "bg-red-100",
            ]),
          }),
          Input(
            $props({
              value: text,
              oninput: (e) => setText(e.target.value),
            })
          ),
          Div(
            $props({
              className: cn(() => [todoSignal().done && "line-through"]),
            }),
            todoSignal().name
          ),
          Div(
            Button(
              $props({
                onclick: onDone,
                className: cn(() => [
                  "h-10 px-3 rounded font-bold text-1xl transition",
                  todoSignal().done && "hover:bg-red-50 bg-red-200",
                  !todoSignal().done && "hover:bg-green-50 bg-green-100",
                ]),
              }),
              Show({
                when: react(() => todoSignal().done),
                content: "❌",
                fallBack: "✅",
              })
            ),
            Button(
              $props({
                onclick: onRemove,
                className: cn(
                  "ml-4 h-10 px-3 rounded font-bold text-1xl transition",
                  "hover:bg-red-50 bg-red-200"
                ),
              }),
              "🗑️"
            )
          )
        );
      };

      const TodoApp = () => {
        const toast = useToast();
        const [inputText, setInputText] = signal("");
        const [todos, setTodos] = signal([
          { id: genId(), name: "1", done: true },
          { id: genId(), name: "2", done: true },
          { id: genId(), name: "3", done: false },
        ]);

        effect(() => {
          console.log("todos", todos());
        });

        const handleTodoToggle = (id) => {
          setTodos(
            todos().map((t) => {
              if (t.id === id) t.done = !t.done;
              return t;
            })
          );
        };

        const handleRemoveTodo = (id) => {
          setTodos(todos().filter((t) => t.id !== id));
        };

        const handleAddTodo = () => {
          if (inputText().length === 0) {
            // alert("you cannot create a empty todo!");
            toast("you cannot create a empty todo!")
            return;
          }
          setTodos([
            ...todos(),
            { id: genId(), name: inputText(), done: false },
          ]);
          setInputText("");
        };

        return Layout(
          Div(
            $props({
              className:
                "flex flex-col gap-4 border p-4 bg-white rounded max-w-[600px] w-full",
            }),
            H1($props({ className: "text-lg font-bold" }), "Todo App"),
            Hr(),
            Show({
              when: react(() => todos().length > 0),
              content: Div(
                $props({ className: "max-h-[300px] overflow-auto" }),
                List({
                  data: todos,
                  keyExtractor: (todo) => todo().id,
                  render: (todo) =>
                    TodoItem({
                      todoSignal: todo,
                      onDone: () => handleTodoToggle(todo().id),
                      onRemove: () => handleRemoveTodo(todo().id),
                    }),
                })
              ),
              fallBack: Div(
                $props({ className: "text-center" }),
                "Nenhuma todo cadastrada."
              ),
            }),
            Hr(),
            Div(
              $props({ className: "flex gap-4" }),
              Input(
                $props({
                  placeholder: "Your next incredible task",
                  oninput: (e) => setInputText(e.target.value),
                  value: inputText,
                  className: "h-10 px-2 bg-zinc-100 w-full",
                })
              ),
              Button(
                $props({
                  className:
                    "h-10 px-4 rounded bg-green-500 text-white hover:bg-green-400 transition",
                  onclick: handleAddTodo,
                }),
                "create"
              ),
              Button(
                $props({
                  className:
                    "h-10 px-4 rounded bg-green-500 text-white hover:bg-green-400 transition text-nowrap",
                  onclick: () => {
                    setTodos(
                      todos()
                        .map((t) => ({ ...t, done: true }))
                        .reverse()
                    );
                  },
                }),
                "invert and done"
              )
            )
          )
        );
      };

      bootstrap(app, TodoApp);
    </script>
  </body>
</html>
